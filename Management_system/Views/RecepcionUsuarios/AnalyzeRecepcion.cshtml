@model Management_system.Models.Others.Analyze.AnalyzeRecepcionViewModel

@{
    ViewData["Title"] = "Análisis de Recepciones";
    Layout = "~/Views/Shared/_Layout_main.cshtml";
}

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">

<style>
    .fixed-width-btn {
        width: 80px;
    }

    .alert-custom {
        color: red;
        font-size: 1.2em;
        display: none;
        margin-top: 10px;
    }

    .card {
        border-radius: 15px;
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        border-bottom: 1px solid #e5e5e5;
        padding-bottom: 0.5rem;
        text-transform: uppercase;
    }

    input[type="submit"] {
        width: 150px;
    }


    .title-main {
        font-size: 1.6em;
        color: #333;
    }

    .title-menu {
        font-size: 1.4em;
        color: #333;
    }

    .card-header-title {
        font-size: 1.1em;
        color: #333;
    }

    .lead {
        font-size: 1.1rem;
        font-weight: 300;
    }

    .lead-content {
        font-size: 1.0rem;
        font-weight: 300;
    }

    .btn {
        /* background-color: #007bff;
                        border-color: #007bff; */
        font-weight: 500;
        padding: 5px 15px;
        border-radius: 20px;
        transition: background-color 0.3s ease;
    }




    .table {
        background-color: #ffffff;
        border-radius: 10px;
        overflow: hidden;
    }

        .table th {
            /* background-color: #343a40;
                color: #ffffff; */
            text-align: center;
            font-weight: 600;
            vertical-align: middle;
            font-size: 1rem;
        }

        .table td {
            text-align: center;
            vertical-align: middle;
            font-size: 0.95rem;
            color: #495057;
        }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f2f2f2;
    }

    .table-hover tbody tr:hover {
        background-color: #e9ecef;
    }

    #productosChart {
        width: 100% !important;
        height: auto !important;
        max-height: 500px; /* Ajusta la altura máxima según necesidad */
    }

</style>


<div class="container">
    <a asp-action="RecepcionMercancia" asp-controller="Main" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
</div>


<div class="container mt-2">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card shadow-lg rounded-4 p-3">
                <div class="card-body">
                    <p class="text-center title-menu">Analisis de Recepciones</p>

                    <hr />
                    <p>Total de Recepciones: @Model.TotalRecepciones</p>

                    @* <form id="chartForm" method="post" asp-action="DownloadPDF" asp-controller="SolicitudUsuarios">
                        <input type="hidden" name="asesor" value="@ViewBag.Asesor" />
                        <input type="hidden" name="usuario" value="@ViewBag.Usuario" />
                        <button type="submit" class="btn btn-primary">Descargar PDF</button>
                    </form> *@

                    <form method="get" asp-action="AnalyzeRecepcion" asp-controller="RecepcionUsuarios">
                        <div class="row">
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="asesor">Asesor</label>
                                    <select name="asesor" id="asesor" class="form-control">
                                        <option value="">Todos</option>
                                        @if (Model.Asesores != null)
                                        {
                                            @foreach (var asesor in Model.Asesores)
                                            {
                                                <option value="@asesor">@asesor</option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <div class="form-group">
                                    <label for="usuario">Usuario</label>
                                    <select name="usuario" id="usuario" class="form-control">
                                        <option value="">Todos</option>
                                        @if (Model.Usuarios != null)
                                        {
                                            @foreach (var usuario in Model.Usuarios)
                                            {
                                                <option value="@usuario">@usuario</option>
                                            }
                                        }
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-2">
                                <div class="form-group text-center">
                                    <button type="submit" class="btn btn-primary">Filtrar</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>


            <div class="card shadow-lg rounded-4 p-3 mt-2">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h5 class="text-center">Recepciones por Mes</h5>
                            <div style="width: 100%; max-width: 900px; height: auto; margin: auto; position: relative;">
                                <canvas id="recepcionesPorMesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg rounded-4 p-3 mt-2">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-center">Top productos más recepcionados</h5>
                            <div style="width: 100%; max-width: 600px; height: 400px; margin: auto; position: relative; display: flex; justify-content: center; align-items: center;">
                                <canvas id="productosMasRecepcionadosChart"></canvas>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5 class="text-center">Top 10 proveedores</h5>
                            <div style="width: 100%; max-width: 600px; height: 400px; margin: auto; position: relative; display: flex; justify-content: center; align-items: center;">
                                <canvas id="recepcionPorProveedorChart"></canvas>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <div class="card shadow-lg rounded-4 p-3 mt-2">
                <div class="card-body">

                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-center">Recepciones por Usuario</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th class="col-usuario">Usuario</th>
                                            <th class="col-cantidad">Cantidad de Recepciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.RecepcionPorUsuarios != null)
                                        {
                                            @foreach (var item in Model.RecepcionPorUsuarios)
                                            {
                                                <tr>
                                                    <td class="col-usuario">@item.Usuario</td>
                                                    <td class="col-cantidad">@item.Count</td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h5 class="text-center">Recepción por Asesor</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th class="col-asesor">Asesor</th>
                                            <th class="col-cantidad">Cantidad de Recepciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.RecepcionPorAsesores != null)
                                        {
                                            @foreach (var item in Model.RecepcionPorAsesores)
                                            {
                                                <tr>
                                                    <td class="col-asesor">@item.Asesor</td>
                                                    <td class="col-cantidad">@item.Count</td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Datos desde el modelo
            var recepcionesPorMes = @Html.Raw(Json.Serialize(Model.RecepcionesPorMes));
            var productosMasRecepcionados = @Html.Raw(Json.Serialize(Model.ProductoMasRecepcionados));
            var recepcionPorProveedor = @Html.Raw(Json.Serialize(Model.RecepcionPorProveedores));

            // Gráfico de Recepciones por Mes
            var ctx1 = document.getElementById('recepcionesPorMesChart').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: recepcionesPorMes.map(r => `${r.month}/${r.year}`),
                    datasets: [{
                        label: 'Recepciones por Mes',
                        data: recepcionesPorMes.map(r => r.count),
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Gráfico de Productos Más Recepcionados
            var ctx2 = document.getElementById('productosMasRecepcionadosChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: productosMasRecepcionados.map(p => p.referencia),
                    datasets: [{
                        label: 'Total Comprado',
                        data: productosMasRecepcionados.map(p => p.totalCantidad),
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y', // Barras horizontales
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });

            // Gráfico de Recepción por Proveedor
            var ctx3 = document.getElementById('recepcionPorProveedorChart').getContext('2d');
            new Chart(ctx3, {
                type: 'pie',
                data: {
                    labels: recepcionPorProveedor.map(p => p.proveedor),
                    datasets: [{
                        label: 'Total Comprado',
                        data: recepcionPorProveedor.map(p => p.totalComprado),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(153, 102, 255, 0.5)',
                            'rgba(255, 159, 64, 0.5)',
                            'rgba(255, 205, 86, 0.5)',
                            'rgba(54, 162, 235, 0.5)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true
                }
            });
        });
    </script>
}
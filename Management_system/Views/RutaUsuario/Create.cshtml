@model Management_system.Models.Rutum

@{
    ViewData["Title"] = "Crear Novedad Ruta";
    Layout = "~/Views/Shared/_Layout_main.cshtml";
}


<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">

<style>
    .fixed-width-btn {
        width: 60px;
    }

    .alert-custom {
        color: red;
        font-size: 1.2em;
        display: none;
        margin-top: 10px;
    }

    .card {
        border-radius: 15px;
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        border-bottom: 1px solid #e5e5e5;
        padding-bottom: 0.5rem;
        text-transform: uppercase;
    }

    input[type="submit"] {
        width: 180px;
    }


    .title-main {
        font-size: 1.6em;
        color: #333;
    }

    .title-menu {
        font-size: 1.4em;
        color: #333;
    }

    .title-Submenu {
        font-size: 1.3em;
        color: #333;
    }

    .card-header-title {
        font-size: 1.1em;
        color: #333;
    }

    .lead {
        font-size: 1.1rem;
        font-weight: 300;
    }

    .lead-content {
        font-size: 1.0rem;
        font-weight: 300;
    }

    .btn {
        /* background-color: #007bff;
                                border-color: #007bff; */
        font-weight: 500;
        padding: 5px 15px;
        border-radius: 20px;
        transition: background-color 0.3s ease;
    }



    .table {
        background-color: #ffffff;
        border-radius: 10px;
        overflow: hidden;
    }

        .table th {
            /* background-color: #343a40;
                        color: #ffffff; */
            text-align: center;
            font-weight: 600;
            vertical-align: middle;
            font-size: 1rem;
        }

        .table td {
            text-align: center;
            vertical-align: middle;
            font-size: 0.95rem;
            color: #495057;
        }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f2f2f2;
    }

    .table-hover tbody tr:hover {
        background-color: #e9ecef;
    }

</style>


<div class="container">
    <a asp-action="Logistica" asp-controller="Main" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
</div>


<div class="container mt-2">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <form asp-action="Create">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        
                <div class="form-group">
                    <input asp-for="FechaAsignacion" class="form-control" type="hidden" readonly value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
                    <span asp-validation-for="FechaAsignacion" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <input asp-for="IdUsuario" type="hidden" class="form-control" asp-items="ViewBag.IdUsuario"/>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p class="text-center title-menu">Programar Ruta</p>
                        <hr />
                        <p class="title-Submenu">Busqueda</p>

                        <div class="form-group">
                            <select id="tipoNovedad" class="form-control lead-content">
                                <option value="" class="lead-content">Seleccionar Novedad</option>
                                <option value="general" class="lead-content">Novedad General</option>
                                <option value="comercial" class="lead-content">Novedad Comercial</option>
                                <option value="compras" class="lead-content">Novedad Compras</option>
                            </select>
                        </div>

                        @* Novedad General *@
                        <div class="row mt-2" id="novedadGeneralFields" style="display: none;">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="searchNovedadG" class="control-label card-header-title">Buscar Novedad General</label>
                                    <input type="text" id="searchNovedadG" class="form-control lead-content" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="IdNovedadGeneral" class="control-label card-header-title">Novedad General</label>
                                    <select asp-for="IdNovedadGeneral" class="form-control lead-content" id="selectNovedadG">
                                        <option value="">Seleccionar Novedad</option>
                                    </select>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label card-header-title">Nombre Empresa</label>
                                    <input type="text" id="descripcionEmpresa" class="form-control lead-content" readonly />
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label card-header-title">Empresa</label>
                                    <input type="text" id="descripcionEmpresaS" class="form-control lead-content" readonly />
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="control-label card-header-title">Solicitado por</label>
                                    <input type="text" id="descripcionSolicitado" class="form-control lead-content" readonly />
                                </div>
                            </div>

                        </div>


                        @* Novedad Comercial *@
                        <div class="row mt-2" id="novedadComercialFields" style="display: none;">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="searchNovedadCM" class="control-label card-header-title">Buscar Novedad Comercial</label>
                                    <input type="text" id="searchNovedadCM" class="form-control lead-content" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="IdNovedadComercial" class="control-label card-header-title">Novedad Comercial</label>
                                    <select asp-for="IdNovedadComercial" class="form-control lead-content" id="selectNovedadCM">
                                        <option value="">Seleccionar Novedad Comercial</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="control-label card-header-title">Cliente Nombre</label>
                                    <input type="text" id="descripcionEmpresa1" class="form-control lead-content" readonly />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="control-label card-header-title">Tipo Documento</label>
                                    <input type="text" id="descripcionTipoDocumento" class="form-control lead-content" readonly />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="control-label card-header-title">Empresa</label>
                                    <input type="text" id="descripcionEmpresaS1" class="form-control lead-content" readonly />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="control-label card-header-title">Solicitado por</label>
                                    <input type="text" id="descripcionSolicitado1" class="form-control lead-content" readonly />
                                </div>
                            </div>
                        </div>


                        @* Novedad Compras *@
                        <div class="row mt-2" id="novedadComprasFields" style="display: none;">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="searchNovedadCP" class="control-label card-header-title">Buscar Novedad Compra</label>
                                    <input type="text" id="searchNovedadCP" class="form-control lead-content" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="IdNovedadCompras" class="control-label card-header-title">Novedad Compra</label>
                                    <select asp-for="IdNovedadCompras" class="form-control lead-content" id="selectNovedadCP">
                                        <option value="">Seleccionar Novedad Compra</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-2">
                    <div class="card-body">

                        <p class="title-Submenu">Datos</p>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label asp-for="IdConductor" class="control-label card-header-title">Asignado a</label>
                                    <select asp-for="IdConductor" class="form-control lead-content" asp-items="ViewBag.IdConductor" required></select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label asp-for="FechaRuta" class="control-label card-header-title">Fecha de Servicio</label>
                                    <input asp-for="FechaRuta" class="form-control lead-content" type="date" required />
                                    <span asp-validation-for="FechaRuta" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label asp-for="Campo1" class="control-label card-header-title">Valor</label>
                                    <input asp-for="Campo1" class="form-control lead-content" />
                                    <span asp-validation-for="Campo1" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-md-3">
                                <div class="form-group">
                                    <label asp-for="Observaciones" class="control-label card-header-title">Observaciones Generales</label>
                                    <input asp-for="Observaciones" class="form-control lead-content" />
                                    <span asp-validation-for="Observaciones" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        @* <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="NGuia" class="control-label card-header-title">N° de Guía</label>
                                    <input asp-for="NGuia" class="form-control lead-content" />
                                    <span asp-validation-for="NGuia" class="text-danger"></span>
                                </div>
                            </div>
                            
                        </div> *@

                        <div class="form-group text-center mt-3">
                            <input type="submit" value="Programar Novedad" class="btn btn-primary" />
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="container mt-4">

    <div class="row">
        <div class="col-md-6 mb-3">
            <div class="card rounded-4 h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-calendar-alt fa-3x text-dark"></i>
                    </div>
                    <h4 class="card-title fw-normal text-capitalize">Reprogramar Ruta</h4>
                    <p class="card-text text-muted">Permite modificar la ruta asignada, ajustando fechas y conductor.</p>
                    <a asp-action="ReviewIndex" asp-controller="RutaUsuario" class="btn btn-dark px-4 rounded-pill">
                        <i class="fas fa-map-marked-alt me-2"></i> Reprogramar
                    </a>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card rounded-4 h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="fas fa-route fa-3x text-success"></i>
                    </div>
                    <h4 class="card-title fw-normal text-capitalize">Generar Ruta</h4>
                    <p class="card-text text-muted">Consulta la ruta asignada para el día de hoy según tu rol.</p>
                    <a asp-action="GenerarRuta" asp-controller="RutaUsuario" class="btn btn-success px-4 rounded-pill">
                        <i class="fas fa-map-marked-alt me-2"></i> Consultar Ruta
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de éxito -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">Éxito</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Ruta guardada exitosamente.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            // Mostrar modal si la ruta se ha guardado con éxito
            var success = '@TempData["Success"]';
            if (success === "True") {
                $('#successModal').modal('show');
            }

            // Forzar el cierre del modal al hacer clic en el botón de cerrar o la "X"
            $('#successModal').on('hidden.bs.modal', function () {
                // Eliminar el modal correctamente
                $(this).modal('hide');
                $('body').removeClass('modal-open'); // Eliminar la clase que bloquea el fondo
                $('.modal-backdrop').remove();
            });

            // Cuando se hace clic en el botón de "Close"
            $('#successModal .btn-secondary').click(function () {
                $('#successModal').modal('hide');
            });

            // Cuando se cierra el modal con la "X"
            $('#successModal .close').click(function () {
                $('#successModal').modal('hide');
            });
        });
    </script>

    <script>

        $(document).ready(function () {


            // Al cambiar el tipo de novedad
            $("#tipoNovedad").change(function () {
                var selectedNovedad = $(this).val();

                // Ocultar todos los campos
                $("#novedadGeneralFields").hide();
                $("#novedadComercialFields").hide();
                $("#novedadComprasFields").hide();

                // Mostrar el campo correspondiente
                if (selectedNovedad === "general") {
                    $("#novedadGeneralFields").show();
                } else if (selectedNovedad === "comercial") {
                    $("#novedadComercialFields").show();
                } else if (selectedNovedad === "compras") {
                    $("#novedadComprasFields").show();
                }
            });

            // NovedadGeneral
            $("#searchNovedadG").on("input", function () {
                var query = $(this).val();
                if (query.length > 2) { // Buscar después de que el usuario haya ingresado al menos 3 caracteres
                    $.ajax({
                        url: '@Url.Action("SearchNovedadGeneral", "RutaUsuario")',
                        data: { term: query },
                        success: function (data) {
                            var select = $("#selectNovedadG");
                            select.empty();
                            select.append($("<option>").val("").text("Seleccione una Novedad"));
                            $.each(data, function (index, item) {
                                select.append($("<option>").val(item.value).text(item.text));
                            });
                        }
                    });
                }
            });

            $("#selectNovedadG").change(function () {
                var novedadGId = $(this).val();
                if (novedadGId) {
                    $.ajax({
                        url: '@Url.Action("GetNovedadGeneralCliente", "RutaUsuario")',
                        data: { id: novedadGId },
                        success: function (data) {
                            $("#descripcionEmpresa").val(data.description);
                            $("#descripcionEmpresaS").val(data.empresa);
                            $("#descripcionSolicitado").val(data.solicitado);
                        }
                    });
                } else {
                    $("#descripcionEmpresa").val('');
                    $("#descripcionEmpresaS").val('');
                    $("#descripcionSolicitado").val('');
                }
            });

            

            // Novedad Comercial
            $("#searchNovedadCM").on("input", function () {
                var query = $(this).val();
                if (query.length > 2) { // Buscar después de que el usuario haya ingresado al menos 3 caracteres
                    $.ajax({
                        url: '@Url.Action("SearchNovedadComercial", "RutaUsuario")',
                        data: { term: query },
                        success: function (data) {
                            var select = $("#selectNovedadCM");
                            select.empty();
                            select.append($("<option>").val("").text("Seleccione Novedad Comercial"));
                            $.each(data, function (index, item) {
                                select.append($("<option>").val(item.value).text(item.text));
                            });
                        }
                    });
                }
            });

            $("#selectNovedadCM").change(function () {
                var novedadCMId = $(this).val();
                if (novedadCMId) {
                    $.ajax({
                        url: '@Url.Action("GetNovedadComercialCliente", "RutaUsuario")',
                        data: { id: novedadCMId },
                        success: function (data) {
                            $("#descripcionEmpresa1").val(data.description1);
                            $("#descripcionTipoDocumento").val(data.tipodocumento);
                            $("#descripcionEmpresaS1").val(data.empresa1);
                            $("#descripcionSolicitado1").val(data.solicitado1);
                        }
                    });
                } else {
                    $("#descripcionEmpresa1").val('');
                    $("#descripcionEmpresa2").val('');
                    $("#descripcionTipoDocumento").val('');
                    $("#descripcionEmpresaS1").val('');
                    $("#descripcionSolicitado1").val('');
                }
            });


            // Novedad Compras
            $("#searchNovedadCP").on("input", function () {
                var query = $(this).val();
                if (query.length > 2) { // Buscar después de que el usuario haya ingresado al menos 3 caracteres
                    $.ajax({
                        url: '@Url.Action("SearchNovedadCompras", "RutaUsuario")',
                        data: { term: query },
                        success: function (data) {
                            var select = $("#selectNovedadCP");
                            select.empty();
                            select.append($("<option>").val("").text("Seleccione Novedad Compra"));
                            $.each(data, function (index, item) {
                                select.append($("<option>").val(item.value).text(item.text));
                            });
                        }
                    });
                }
            });

            var now = new Date();
            var currentHour = now.getHours();
            var currentMinutes = now.getMinutes();

            // Check if the current time is after 4:59 PM
            if (currentHour > 16 || (currentHour === 16 && currentMinutes >= 59)) {
                document.getElementById('timeAlert').style.display = 'block';
            }
        });
    </script>
}
